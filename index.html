<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Manager Pro | CSV → Word Export</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-color: #4361ee;
  --primary-dark: #3a56d4;
  --secondary-color: #7209b7;
  --success-color: #4cc9f0;
  --danger-color: #f72585;
  --warning-color: #f8961e;
  --light-color: #f8f9fa;
  --dark-color: #212529;
  --gray-color: #6c757d;
  --light-gray: #e9ecef;
  --border-color: #dee2e6;
  --card-bg: #ffffff;
  --sidebar-bg: #1a1a2e;
  --sidebar-text: #e2e2e2;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
  --radius: 12px;
  --radius-sm: 8px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color: var(--dark-color);
  min-height: 100vh;
  line-height: 1.6;
}

.container {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
  z-index: 10;
}

.logo {
  display: flex;
  align-items: center;
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo-icon {
  font-size: 28px;
  color: var(--success-color);
  margin-right: 12px;
}

.logo-text {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(90deg, #4cc9f0, #4361ee);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.nav-menu {
  flex: 1;
}

.nav-item {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  margin-bottom: 10px;
  border-radius: var(--radius-sm);
  transition: all 0.3s ease;
  cursor: pointer;
}

.nav-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.nav-item.active {
  background: var(--primary-color);
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.nav-icon {
  font-size: 20px;
  margin-right: 15px;
  width: 24px;
  text-align: center;
}

.nav-text {
  font-size: 16px;
  font-weight: 500;
}

.sidebar-footer {
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
  text-align: center;
}

/* Main Content */
.main-content {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.header-title h1 {
  font-size: 32px;
  font-weight: 700;
  color: var(--dark-color);
  margin-bottom: 5px;
}

.header-title p {
  color: var(--gray-color);
  font-size: 16px;
}

.user-profile {
  display: flex;
  align-items: center;
  background: var(--card-bg);
  padding: 10px 20px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #4361ee, #7209b7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  margin-right: 12px;
}

.user-info h4 {
  font-size: 16px;
  margin-bottom: 2px;
}

.user-info p {
  font-size: 13px;
  color: var(--gray-color);
}

/* Dashboard Cards */
.dashboard-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 24px;
  margin-bottom: 30px;
}

.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: none;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.card-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  margin-bottom: 20px;
}

.card-icon.blue {
  background: linear-gradient(135deg, #4361ee, #3a56d4);
  color: white;
}

.card-icon.green {
  background: linear-gradient(135deg, #4cc9f0, #3a8bc2);
  color: white;
}

.card-icon.purple {
  background: linear-gradient(135deg, #7209b7, #5a0a91);
  color: white;
}

.card-icon.orange {
  background: linear-gradient(135deg, #f8961e, #e07c0c);
  color: white;
}

.card-title {
  font-size: 14px;
  color: var(--gray-color);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.card-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--dark-color);
  margin-bottom: 5px;
}

.card-change {
  font-size: 14px;
  display: flex;
  align-items: center;
}

.card-change.positive {
  color: #28a745;
}

.card-change.negative {
  color: #dc3545;
}

/* File Upload Area */
.upload-section {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 30px;
  box-shadow: var(--shadow);
  margin-bottom: 30px;
}

.section-title {
  display: flex;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 1px solid var(--border-color);
}

.section-title h2 {
  font-size: 22px;
  font-weight: 600;
  color: var(--dark-color);
}

.section-icon {
  width: 40px;
  height: 40px;
  background: var(--primary-color);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  margin-right: 15px;
  font-size: 20px;
}

.upload-area {
  border: 2px dashed var(--border-color);
  border-radius: var(--radius);
  padding: 40px 20px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: var(--primary-color);
  background: rgba(67, 97, 238, 0.02);
}

.upload-area.dragover {
  border-color: var(--primary-color);
  background: rgba(67, 97, 238, 0.05);
}

.upload-icon {
  font-size: 48px;
  color: var(--primary-color);
  margin-bottom: 15px;
}

.upload-text h3 {
  font-size: 18px;
  margin-bottom: 10px;
  color: var(--dark-color);
}

.upload-text p {
  color: var(--gray-color);
  margin-bottom: 20px;
}

.file-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--light-gray);
  padding: 15px 20px;
  border-radius: var(--radius-sm);
  margin-top: 15px;
}

.file-name {
  display: flex;
  align-items: center;
}

.file-icon {
  color: var(--primary-color);
  margin-right: 10px;
  font-size: 20px;
}

.file-size {
  color: var(--gray-color);
  font-size: 14px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 28px;
  font-size: 16px;
  font-weight: 600;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.btn i {
  margin-right: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #4cc9f0, #3a8bc2);
  color: white;
  box-shadow: 0 4px 12px rgba(76, 201, 240, 0.3);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(76, 201, 240, 0.4);
}

.btn-warning {
  background: linear-gradient(135deg, #f8961e, #e07c0c);
  color: white;
  box-shadow: 0 4px 12px rgba(248, 150, 30, 0.3);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(248, 150, 30, 0.4);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.button-group {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

/* Status Messages */
.status-area {
  margin: 20px 0;
}

.alert {
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.alert-success {
  background: rgba(76, 201, 240, 0.1);
  border-left: 4px solid var(--success-color);
  color: #0c5460;
}

.alert-error {
  background: rgba(247, 37, 133, 0.1);
  border-left: 4px solid var(--danger-color);
  color: #721c24;
}

.alert-icon {
  font-size: 20px;
  margin-right: 12px;
}

/* Table Container */
.table-container {
  background: var(--card-bg);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  margin-top: 30px;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 25px;
  border-bottom: 1px solid var(--border-color);
}

.table-header h3 {
  font-size: 20px;
  font-weight: 600;
}

.table-actions {
  display: flex;
  gap: 10px;
}

.table-wrapper {
  overflow-x: auto;
}

#invTable {
  width: 100%;
  border-collapse: collapse;
  min-width: 1200px;
}

#invTable th {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  padding: 18px 12px;
  text-align: center;
  font-weight: 600;
  color: var(--dark-color);
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
}

#invTable td {
  padding: 16px 12px;
  text-align: center;
  border-bottom: 1px solid var(--border-color);
  transition: background 0.2s ease;
}

#invTable tbody tr:hover {
  background: rgba(67, 97, 238, 0.03);
}

#invTable td[contenteditable="true"]:focus {
  background: rgba(255, 193, 7, 0.1);
  outline: 2px solid #ffc107;
  border-radius: 4px;
}

#invTable tfoot td {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  font-weight: 700;
  padding: 18px 12px;
}

.rem-cell {
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  transition: all 0.2s ease;
}

.rem-cell:hover {
  background: rgba(67, 97, 238, 0.1) !important;
}

.rem-selected {
  background: rgba(67, 97, 238, 0.2) !important;
  color: var(--primary-color);
}

/* Footer */
.footer {
  text-align: center;
  padding: 25px;
  color: var(--gray-color);
  font-size: 14px;
  margin-top: 40px;
  border-top: 1px solid var(--border-color);
}

/* Responsive */
@media (max-width: 992px) {
  .container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    padding: 20px;
  }
  
  .nav-menu {
    display: flex;
    overflow-x: auto;
    padding-bottom: 10px;
  }
  
  .nav-item {
    flex: 0 0 auto;
    margin-right: 10px;
    margin-bottom: 0;
  }
  
  .main-content {
    padding: 20px;
  }
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .user-profile {
    margin-top: 15px;
  }
  
  .dashboard-cards {
    grid-template-columns: 1fr;
  }
  
  .button-group {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}

/* Custom file input */
.custom-file-input {
  display: none;
}

.custom-file-label {
  display: inline-flex;
  align-items: center;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

.custom-file-label:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
}

/* Progress bar */
.progress-container {
  margin-top: 20px;
}

.progress-bar {
  height: 8px;
  background: var(--light-gray);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 10px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--success-color));
  border-radius: 4px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-text {
  font-size: 14px;
  color: var(--gray-color);
  text-align: center;
}
</style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">
        <i class="fas fa-cube"></i>
      </div>
      <div class="logo-text">Inventory Pro</div>
    </div>
    
    <nav class="nav-menu">
      <div class="nav-item active">
        <div class="nav-icon">
          <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="nav-text">Dashboard</div>
      </div>
      
      <div class="nav-item">
        <div class="nav-icon">
          <i class="fas fa-file-import"></i>
        </div>
        <div class="nav-text">Import CSV</div>
      </div>
      
      <div class="nav-item">
        <div class="nav-icon">
          <i class="fas fa-table"></i>
        </div>
        <div class="nav-text">Inventory Table</div>
      </div>
      
      <div class="nav-item">
        <div class="nav-icon">
          <i class="fas fa-file-word"></i>
        </div>
        <div class="nav-text">Word Export</div>
      </div>
      
      <div class="nav-item">
        <div class="nav-icon">
          <i class="fas fa-cog"></i>
        </div>
        <div class="nav-text">Settings</div>
      </div>
      
      <div class="nav-item">
        <div class="nav-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <div class="nav-text">Help & Support</div>
      </div>
    </nav>
    
    <div class="sidebar-footer">
      <p>Inventory Manager Pro v2.0</p>
      <p>© 2023 All rights reserved</p>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header-title">
        <h1>Inventory Management System</h1>
        <p>Import CSV files and export professional Word documents</p>
      </div>
      
      <div class="user-profile">
        <div class="user-avatar">AD</div>
        <div class="user-info">
          <h4>Admin User</h4>
          <p>WhatsApp:+1 (989) 510-2574</p>
        </div>
      </div>
    </header>
    
    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
      <div class="card">
        <div class="card-icon blue">
          <i class="fas fa-file-csv"></i>
        </div>
        <div class="card-title">CSV Files</div>
        <div class="card-value" id="csvCount">0</div>
        <div class="card-change positive">
          <i class="fas fa-arrow-up"></i> Ready to import
        </div>
      </div>
      
      <div class="card">
        <div class="card-icon green">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="card-title">Total Items</div>
        <div class="card-value" id="itemCount">0</div>
        <div class="card-change">
          <i class="fas fa-sync-alt"></i> Updated in real-time
        </div>
      </div>
      
      <div class="card">
        <div class="card-icon purple">
          <i class="fas fa-file-word"></i>
        </div>
        <div class="card-title">Word Exports</div>
        <div class="card-value" id="exportCount">0</div>
        <div class="card-change positive">
          <i class="fas fa-arrow-up"></i> Export available
        </div>
      </div>
      
      <div class="card">
        <div class="card-icon orange">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="card-title">Total Value</div>
        <div class="card-value" id="totalValue">$0.00</div>
        <div class="card-change">
          <i class="fas fa-calculator"></i> Auto-calculated
        </div>
      </div>
    </div>
    
    <!-- File Upload Section -->
    <section class="upload-section">
      <div class="section-title">
        <div class="section-icon">
          <i class="fas fa-file-upload"></i>
        </div>
        <h2>Upload CSV File</h2>
      </div>
      
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">
          <h3>Drag & Drop your CSV file here</h3>
          <p>or click to browse files on your computer</p>
          <label for="csvFile" class="custom-file-label">
            <i class="fas fa-folder-open"></i> Browse Files
          </label>
          <input type="file" id="csvFile" accept=".csv" class="custom-file-input">
        </div>
        
        <div id="fileInfo" class="file-info" style="display: none;">
          <div class="file-name">
            <div class="file-icon">
              <i class="fas fa-file-csv"></i>
            </div>
            <span id="fileName">No file selected</span>
          </div>
          <div class="file-size" id="fileSize">0 KB</div>
        </div>
      </div>
      
      <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px; margin-bottom:15px;">
        <label style="display:block; margin-bottom:10px; font-weight:600; color:#333;">
          <i class="fas fa-file-word" style="margin-right:8px;"></i>Optional: Upload Existing Word File Template
        </label>
        <label for="wordTemplate" class="custom-file-label" style="display:inline-block;">
          <i class="fas fa-folder-open"></i> Choose Word Template
        </label>
        <input type="file" id="wordTemplate" accept=".doc,.docx" class="custom-file-input" style="display:none;">
        <div id="wordTemplateInfo" style="margin-top:10px; font-size:14px; color:#666; display:none;">
          <i class="fas fa-check-circle" style="color:#28a745; margin-right:5px;"></i>
          <span id="wordTemplateName">No template selected</span>
        </div>
      </div>
      
      <div class="button-group">
        <button id="loadBtn" class="btn btn-primary" onclick="loadCSV()" disabled>
          <i class="fas fa-upload"></i> Import CSV
        </button>
        <button id="addRowBtn" class="btn btn-success" onclick="addNewRow()" disabled style="display: none;">
          <i class="fas fa-plus-circle"></i> Add New Row
        </button>
        <button id="exportBtn" class="btn btn-warning" onclick="exportWord()" disabled>
          <i class="fas fa-file-export"></i> Export to Word
        </button>
      </div>
      
      <div id="statusArea" class="status-area"></div>
    </section>
    
    <!-- Table Section -->
    <div class="table-container">
      <div class="table-header">
        <h3>Inventory Items</h3>
        <div class="table-actions">
          <button class="btn btn-primary btn-sm" onclick="refreshTable()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
          <button class="btn btn-success btn-sm" onclick="addNewRow()" id="addRowBtn2" disabled>
            <i class="fas fa-plus"></i> Add Item
          </button>
        </div>
      </div>
      
      <div class="table-wrapper">
        <div id="tableArea"></div>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
      <p>Inventory Manager Pro | Advanced CSV processing and Word document generation</p>
      <p>System Status: <span id="systemStatus" style="color: #4cc9f0; font-weight: 600;">Operational</span></p>
    </footer>
  </main>
</div>

<script>
let data = [];
let editingCell = null;
let exportCount = 0;
let wordTemplateFile = null;

// Initialize dashboard
updateDashboard();

// Event listeners for file upload
document.getElementById('csvFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'flex';
    
    // Update UI
    document.getElementById('uploadArea').classList.add('dragover');
    setTimeout(() => {
      document.getElementById('uploadArea').classList.remove('dragover');
    }, 300);
    
    showStatus('File selected: ' + file.name, 'success');
  }
});

// Drag and drop functionality
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', function(e) {
  e.preventDefault();
  this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function() {
  this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
  e.preventDefault();
  this.classList.remove('dragover');
  
  const file = e.dataTransfer.files[0];
  if (file && file.name.endsWith('.csv')) {
    document.getElementById('csvFile').files = e.dataTransfer.files;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'flex';
    
    showStatus('File dropped: ' + file.name, 'success');
  } else {
    showStatus('Please drop a valid CSV file', 'error');
  }
});

// Event listener for Word template upload
document.getElementById('wordTemplate').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    wordTemplateFile = file;
    document.getElementById('wordTemplateName').textContent = file.name;
    document.getElementById('wordTemplateInfo').style.display = 'block';
    showStatus('Word template loaded: ' + file.name, 'success');
  }
});

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showStatus(msg, cls='success') {
  const icon = cls === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
  const alertClass = cls === 'success' ? 'alert-success' : 'alert-error';
  
  document.getElementById('statusArea').innerHTML = `
    <div class="alert ${alertClass}">
      <div class="alert-icon">
        <i class="${icon}"></i>
      </div>
      <div>${msg}</div>
    </div>
  `;
  
  // Auto hide success messages after 5 seconds
  if (cls === 'success') {
    setTimeout(() => {
      const alert = document.querySelector('.alert');
      if (alert) {
        alert.style.opacity = '0';
        alert.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          if (alert.parentElement) {
            alert.parentElement.innerHTML = '';
          }
        }, 500);
      }
    }, 5000);
  }
}

function updateDashboard() {
  document.getElementById('itemCount').textContent = data.length;
  document.getElementById('csvCount').textContent = document.getElementById('csvFile').files.length;
  document.getElementById('exportCount').textContent = exportCount;
  
  // Calculate total value
  let total = 0;
  data.forEach(item => {
    total += Number(item.CIF_Total) || 0;
  });
  document.getElementById('totalValue').textContent = '$' + total.toFixed(2);
}

function loadCSV() {
  const file = document.getElementById('csvFile').files[0];
  if (!file) {
    showStatus('Please select a CSV file first.', 'error');
    return;
  }
  
  // Show loading state
  const loadBtn = document.getElementById('loadBtn');
  const originalHtml = loadBtn.innerHTML;
  loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
  loadBtn.disabled = true;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      parseCSV(e.target.result);
      renderTable();
      document.getElementById('exportBtn').disabled = false;
      document.getElementById('addRowBtn').style.display = 'inline-flex';
      document.getElementById('addRowBtn').disabled = false;
      document.getElementById('addRowBtn2').disabled = false;
      
      showStatus(`Successfully imported ${data.length} inventory items`);
      updateDashboard();
      
      // Restore button
      setTimeout(() => {
        loadBtn.innerHTML = originalHtml;
        loadBtn.disabled = false;
      }, 1000);
      
    } catch (error) {
      showStatus('Error parsing CSV: ' + error.message, 'error');
      loadBtn.innerHTML = originalHtml;
      loadBtn.disabled = false;
    }
  };
  reader.onerror = function() {
    showStatus('Error reading file', 'error');
    loadBtn.innerHTML = originalHtml;
    loadBtn.disabled = false;
  };
  reader.readAsText(file);
}

function parseCSV(text) {
  const rows = text.split('\n').filter(r=>r.trim());
  if (rows.length < 2) {
    throw new Error('CSV file is empty or invalid');
  }
  
  data = rows.slice(1).map(r=>{
    const v = parseCSVRow(r);
    return {
      CaseNo:v[0]||'',
      Dimension:v[1]||'',
      Gross:+v[3]||0,
      Nett:+v[4]||0,
      Desc:v[5]||'',
      Origin:v[6]||'',
      SN:v[7]||'',
      Qty:+v[8]||0,
      CIF_Unit:+v[9]||0,
      CIF_Total:+v[10]||0,
      RemA:v[11]||'',
      RemB:v[12]||'',
      RemC:v[13]||''
    };
  }).filter(row => Object.values(row).some(val => val !== '' && val !== 0));
}

function parseCSVRow(row) {
  const out = [];
  let cur = '', q = false;
  for (const c of row) {
    if (c === '"') q = !q;
    else if (c === ',' && !q) { 
      out.push(cur); 
      cur = ''; 
    } else {
      cur += c;
    }
  }
  out.push(cur);
  return out.map(v => v.replace(/^"|"$/g, '').trim());
}

function calcVolume(dim) {
  if (!dim) return '';
  const [l, b, h] = dim.split('x').map(Number);
  if (isNaN(l) || isNaN(b) || isNaN(h)) return '';
  return ((l * b * h) / 1_000_000).toFixed(3);
}

function calculateTotals() {
  let tg = 0, tn = 0, tc = 0;
  data.forEach(r => {
    tg += Number(r.Gross) || 0;
    tn += Number(r.Nett) || 0;
    tc += Number(r.CIF_Total) || 0;
  });
  return { gross: tg, nett: tn, cif_total: tc };
}

function addNewRow() {
  const newRow = {
    CaseNo: '',
    Dimension: '',
    Gross: 0,
    Nett: 0,
    Desc: '',
    Origin: '',
    SN: '',
    Qty: 0,
    CIF_Unit: 0,
    CIF_Total: 0,
    RemA: '',
    RemB: '',
    RemC: ''
  };
  
  data.push(newRow);
  renderTable();
  showStatus('✅ New inventory item added!');
  updateDashboard();
  
  // Scroll to new row
  setTimeout(() => {
    const newRowElement = document.querySelector(`tr[data-row="${data.length-1}"]`);
    if (newRowElement) {
      newRowElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
}

function renderTable() {
  const totals = calculateTotals();

  let html = `
  <table id="invTable">
  <thead>
    <tr>
      <th rowspan="2">CASE NO</th>
      <th rowspan="2">DIMENSIONS</th>
      <th rowspan="2">VOLUME</th>
      <th colspan="2">WEIGHT</th>
      <th rowspan="2">DESCRIPTION</th>
      <th rowspan="2">ORIGIN</th>
      <th rowspan="2">S/N</th>
      <th rowspan="2">QTY</th>
      <th colspan="2">CIF VALUE</th>
      <th colspan="3">REMARKS</th>
    </tr>
    <tr>
      <th>GROSS</th><th>NETT</th>
      <th>UNIT</th><th>TOTAL</th>
      <th>A</th><th>B</th><th>C</th>
    </tr>
  </thead>
  <tbody>`;

  data.forEach((r, i) => {
    html += `
    <tr data-row="${i}">
      <td contenteditable="true" onblur="updateCell(${i}, 'CaseNo', this)">${r.CaseNo}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'Dimension', this)">${r.Dimension}</td>
      <td>${calcVolume(r.Dimension)}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'Gross', this)">${r.Gross}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'Nett', this)">${r.Nett}</td>
      <td style="text-align:left" contenteditable="true" onblur="updateCell(${i}, 'Desc', this)">${r.Desc}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'Origin', this)">${r.Origin}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'SN', this)">${r.SN}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'Qty', this)">${r.Qty}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'CIF_Unit', this)">${r.CIF_Unit}</td>
      <td contenteditable="true" onblur="updateCell(${i}, 'CIF_Total', this)">${r.CIF_Total}</td>
      <td class="rem-cell ${r.RemA === '✕' ? 'rem-selected' : ''}" onclick="toggleRemark(${i}, 'RemA', this)">${r.RemA === '✕' ? '✕' : ''}</td>
      <td class="rem-cell ${r.RemB === '✕' ? 'rem-selected' : ''}" onclick="toggleRemark(${i}, 'RemB', this)">${r.RemB === '✕' ? '✕' : ''}</td>
      <td class="rem-cell ${r.RemC === '✕' ? 'rem-selected' : ''}" onclick="toggleRemark(${i}, 'RemC', this)">${r.RemC === '✕' ? '✕' : ''}</td>
    </tr>`;
  });

  html += `
  </tbody>
  <tfoot>
    <tr>
      <td colspan="3">TOTAL</td>
      <td>${totals.gross.toFixed(2)}</td>
      <td>${totals.nett.toFixed(2)}</td>
      <td colspan="4"></td>
      <td></td>
      <td>${totals.cif_total.toFixed(2)}</td>
      <td colspan="3"></td>
    </tr>
  </tfoot>
  </table>`;

  document.getElementById('tableArea').innerHTML = html;
  updateDashboard();
}

function updateCell(rowIndex, field, cell) {
  try {
    let newValue = cell.textContent.trim();
    
    if (['Gross', 'Nett', 'Qty', 'CIF_Unit', 'CIF_Total'].includes(field)) {
      newValue = +newValue || 0;
    }
    
    data[rowIndex][field] = newValue;
    renderTable();
    showStatus(`Updated ${field} field`);
  } catch (error) {
    showStatus('Error updating cell: ' + error.message, 'error');
  }
}

function toggleRemark(rowIndex, field, cell) {
  try {
    const row = cell.parentElement;
    row.querySelectorAll('.rem-cell').forEach(td => {
      td.textContent = '';
      td.classList.remove('rem-selected');
    });

    data[rowIndex].RemA = '';
    data[rowIndex].RemB = '';
    data[rowIndex].RemC = '';

    if (cell.textContent !== '✕') {
      cell.textContent = '✕';
      cell.classList.add('rem-selected');
      data[rowIndex][field] = '✕';
    }
    
    renderTable();
    showStatus(`Remark ${field} toggled`);
  } catch (error) {
    showStatus('Error toggling remark: ' + error.message, 'error');
  }
}

// Generate template header and form fields (like the image template)
function generateTemplateHeader() {
  return `
    <!-- Main Title - FIRST in the Word document -->
    <p class="main-title" style="text-align:center; font-size:20.0pt; font-weight:bold; text-decoration:underline; margin-bottom:20px; margin-top:0;">
      COMBINED COMMERCIAL INVOICE & PACKING LIST No. 43967
    </p>
    
    <!-- RED FIELD - Front Fields Section (After title) -->
    <!-- Exhibitor and Contact Information - Two Column Layout -->
    <table class="form-table" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
      <tr>
        <!-- Left Column: Exhibitor Information -->
        <td style="width:50%; vertical-align:top; padding-right:20px;">
          <table class="form-table" style="width:100%; border-collapse:collapse;">
            <tr>
              <td class="form-label" style="font-weight:bold; white-space:nowrap; padding-right:10px; vertical-align:bottom; width:1%;">NAME OF EXHIBITOR:</td>
              <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-left:5px; padding-bottom:2px; width:100%;">ELBIT SYSTEMS LTD</td>
            </tr>
            <tr>
              <td style="vertical-align:bottom; padding-right:10px;">
                <table style="border-collapse:collapse;">
                  <tr>
                    <td style="vertical-align:bottom; padding-right:5px; font-size:12.0pt; font-weight:bold;">2019</td>
                    <td class="form-label" style="font-weight:bold; white-space:nowrap; vertical-align:bottom; padding-left:55px; padding-right:10px;">ADDRESS:</td>
                  </tr>
                </table>
              </td>
              <td style="vertical-align:bottom; padding-left:5px; padding-bottom:0px;">
                <table style="width:100%; border-collapse:collapse;">
                  <tr>
                    <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-bottom:0px; width:60%;">P.O.BOX 539, HAIFA, ISAREL</td>
                    <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-left:10px; padding-bottom:0px; width:40%;">&nbsp;</td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td style="vertical-align:bottom; padding-right:10px;">
                <p style="margin:0; font-size:12.0pt; font-weight:bold;">, SEOL</p>
              </td>
              <td style="vertical-align:bottom; padding-left:5px; padding-bottom:2px;">
                <table style="width:100%; border-collapse:collapse;">
                  <tr>
                    <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-bottom:2px; width:30%;">&nbsp;</td>
                   
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td class="form-label" style="font-weight:bold; white-space:nowrap; padding-right:10px; vertical-align:bottom; width:1%;">CONSIGNEE:</td>
              <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-left:5px; padding-bottom:2px; width:100%;">&nbsp;</td>
            </tr>
            <tr>
              <td class="form-label" style="font-weight:bold; white-space:nowrap; padding-right:10px; vertical-align:bottom; width:2%;">2019 15-20/10</td>
              <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-left:5px; padding-bottom:2px; width:70%;text-align:center;">TEL:</td>
            </tr>
            <tr>
              <td class="width:10%;"></td>
              <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-left:5px; padding-bottom:2px; width:50%;text-align:center;">BY AIR</td>
            </tr>
          </table>
        </td>
        
        <!-- Right Column: Stand/Contact/Remarks -->
        <td style="width:50%; vertical-align:top; padding-left:20px;">
          <table class="form-table" style="width:100%; border-collapse:collapse;">
            <tr>
              <td class="form-label" style="font-weight:bold; white-space:nowrap; padding-right:10px; vertical-align:bottom; width:1%;">STAND NO.:</td>
            </tr>
            <tr>
              <td class="form-input-line" style="border-top:1.0pt solid windowtext; vertical-align:top; padding-left:5px; padding-bottom:0px; width:100%;">&nbsp;</td>
            </tr>
             
           
            <tr>
              <td style="vertical-align:bottom; padding-right:10px; border-top:1.0pt solid windowtext;">
                <table style="border-collapse:collapse;">
                  <tr>
                    <td class="form-label" style="font-weight:bold; white-space:nowrap; vertical-align:bottom; padding-right:5px;">TELEPHONE NO.:</td>
                    <td class="form-label" style="font-weight:bold; white-space:nowrap; vertical-align:bottom; padding-left:10px;">FAX:</td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td style="vertical-align:bottom; padding-left:5px; padding-bottom:2px;">
                <table style="width:100%; border-collapse:collapse;">
                  <tr>
                    <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-bottom:2px; width:48%;">&nbsp;</td>
                    <td style="width:4%;"></td>
                    <td class="form-input-line" style="border-bottom:1.0pt solid windowtext; vertical-align:bottom; padding-bottom:2px; width:48%;">&nbsp;</td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              
                <p class="form-remarks-title" style="font-weight:bold; text-decoration:underline; margin-bottom:8px; font-size:12.0pt; text-align:left;margin-left:820px;float:right;">REMARKS</p>
        
              
            </tr>
            <td>
                <div class="form-remarks-options" style="font-size:10.0pt; line-height:1.6; margin-left:20px; text-align:left;">
                  <p style="margin:5px 0 0 300px;">A : RE-EXPORT</p>
                  <p style="margin:5px 0 0 200px;">B : DISPOSED OF/CONSUMED</p>
                  <p style="margin:5px 0 0 250px;">C : GIVEN AWAY/SOLD</p>
                  <p style="margin:8px 0 0 300px; font-style:italic;:right;">* PLEASE TICK WHERE APPLICABLE</p>
                </div>
              </td>
          </table>
        </td>
      </tr>
    </table>
    
    <!-- Space before table (red oval area) -->
    <p style="margin:20px 0;">&nbsp;</p>
  `;
}

// Generate declaration footer text
function generateDeclarationFooter() {
  return `
    <!-- Declaration Footer -->
    <div class="footer-container" style="margin-top:40px; font-size:10.0pt; line-height:1.5; width:100%;">
      <p style="margin-left:100px; text-align:justify;">
        <p style="margin-left:100px;">
        The exporter of the products covered by this document (Customs authorization no. )
        </P>
        <p>
          <span style="display: inline-block; width: 200px;">
            Signed for and on behalf of Authorized Signatory: 
          </span>
           &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        declares that except where otherwise clearly indicated, these products are of Israeli preferential origin 
        <p style="margin-left:200px">
        Country: <span style=" padding:2px 5px; min-width:100px;text-decoration: underline; text-align:center; font-weight:bold; margin-left:100px;">Israel</span> 
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="display: inline-block; width: 200px;">
        <span style="margin-left:100px;">Date:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span style="display: inline-block; width: 200px;">
        <span style="display: inline-block; width: 200px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          and are intended for display purposes only at the exhibition site.
        </span>
        </p>
        </p>
      </p>
      <p style="margin-top:15px; text-align:right;">
        <span style="margin-right:20px;">Name in Block Letters:</span>
        <span>Page</span>
        <span style="border-bottom:1px solid windowtext;  text-decoration: underline; width:30px; text-align:center;">1</span> 
        of 
        <span style="border-bottom:1px solid windowtext;  text-decoration: underline; width:30px; text-align:center;">1</span>
      </p>
    </div>
  `;
}

// Generate table HTML only
function generateTableHTML(totals) {
  let tableHTML = `
    <!-- Main Inventory Table -->
    <table class="inventory-table" cellspacing="0" cellpadding="0" style="mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse">
      <!-- Header Row 1 (with rowspan) -->
      <thead>
        <tr class="main-header">
          <th class="col-case" rowspan="2">CASE NO.</th>
          <th class="col-dims" rowspan="2">DIMENSIONS<br/>L x B x H (cm)</th>
          <th class="col-volume" rowspan="2">VOLUME<br/>(M³)</th>
          <th class="col-weight" colspan="2">WEIGHT (KG)</th>
          <th class="col-desc" rowspan="2">DESCRIPTION OF GOODS</th>
          <th class="col-origin" rowspan="2">Country of<br/>Origin</th>
          <th class="col-sn" rowspan="2">S/N</th>
          <th class="col-cif" colspan="3">CIF VALUE (USD$)</th>
          <th class="col-remarks" colspan="3">REMARKS</th>
        </tr>
        
        <!-- Header Row 2 (sub-headers) -->
        <tr class="sub-header">
          <th class="col-weight center">GROSS</th>
          <th class="col-weight center">NETT</th>
          <th class="col-qty center">QUANTITY</th>
          <th class="col-cif center">UNIT VALUE</th>
          <th class="col-cif center">TOTAL VALUE</th>
          <th class="col-remarks center">A</th>
          <th class="col-remarks center">B</th>
          <th class="col-remarks center">C</th>
        </tr>
      </thead>
      
      <!-- Table Body -->
      <tbody>`;
  
  // Add data rows - exactly as displayed in the table
  data.forEach((r) => {
    const volume = calcVolume(r.Dimension);
    
    tableHTML += `
      <tr>
        <td class="col-case center">${r.CaseNo || ''}</td>
        <td class="col-dims">${r.Dimension || ''}</td>
        <td class="col-volume center">${volume}</td>
        <td class="col-weight center">${r.Gross || ''}</td>
        <td class="col-weight center">${r.Nett || ''}</td>
        <td class="col-desc left">${r.Desc || ''}</td>
        <td class="col-origin center">${r.Origin || ''}</td>
        <td class="col-sn left">${r.SN || ''}</td>
        <td class="col-qty center">${r.Qty || ''}</td>
        <td class="col-cif center">${r.CIF_Unit ? r.CIF_Unit.toFixed(2) : ''}</td>
        <td class="col-cif center">${r.CIF_Total ? r.CIF_Total.toFixed(2) : ''}</td>
        <td class="col-remarks center">${r.RemA === '✕' ? 'X' : ''}</td>
        <td class="col-remarks center">${r.RemB === '✕' ? 'X' : ''}</td>
        <td class="col-remarks center">${r.RemC === '✕' ? 'X' : ''}</td>
      </tr>`;
  });
  
  // Add total row
  tableHTML += `
    </tbody>
    
    <!-- Footer with Totals -->
    <tfoot>
      <tr class="total-row">
        <td class="col-case center" colspan="3"><strong>TOTAL</strong></td>
        <td class="col-weight center"><strong>${totals.gross.toFixed(2)}</strong></td>
        <td class="col-weight center"><strong>${totals.nett.toFixed(2)}</strong></td>
        <td class="col-desc left" colspan="3"></td>
        <td class="col-qty center"></td>
        <td class="col-cif center"></td>
        <td class="col-cif center"><strong>${totals.cif_total.toFixed(2)}</strong></td>
        <td class="col-remarks center" colspan="3"></td>
      </tr>
    </tfoot>
  </table>`;
  
  return tableHTML;
}

// Insert table into existing Word template
async function insertTableIntoTemplate(templateFile, tableHTML, exportBtn, originalHtml) {
  try {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        let templateContent = e.target.result;
        
        // Try to find placeholder (users can add <!--TABLE_PLACEHOLDER--> in their Word file saved as HTML)
        if (templateContent.includes('<!--TABLE_PLACEHOLDER-->')) {
          templateContent = templateContent.replace('<!--TABLE_PLACEHOLDER-->', tableHTML);
        } else if (templateContent.includes('{{TABLE}}')) {
          templateContent = templateContent.replace('{{TABLE}}', tableHTML);
        } else {
          // Insert table before </body> or at the end
          const bodyEndIndex = templateContent.lastIndexOf('</body>');
          if (bodyEndIndex !== -1) {
            templateContent = templateContent.slice(0, bodyEndIndex) + tableHTML + '\n    ' + templateContent.slice(bodyEndIndex);
          } else {
            // If no </body> tag, append at the end
            templateContent += '\n' + tableHTML;
          }
        }
        
        // Create blob and save
        const blob = new Blob(['\ufeff', templateContent], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = templateFile.name.replace(/\.(doc|docx)$/i, '_with_table.doc');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        exportCount++;
        updateDashboard();
        showStatus('✅ Table inserted into Word template successfully!');
        
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
      } catch (error) {
        showStatus('Error processing template: ' + error.message, 'error');
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
      }
    };
    
    reader.onerror = function() {
      showStatus('Error reading template file', 'error');
      exportBtn.innerHTML = originalHtml;
      exportBtn.disabled = false;
    };
    
    // Read as text (works for HTML-based Word files)
    reader.readAsText(templateFile);
  } catch (error) {
    showStatus('Error: ' + error.message, 'error');
    exportBtn.innerHTML = originalHtml;
    exportBtn.disabled = false;
  }
}

async function exportWord() {
  try {
    if (!document.getElementById('invTable')) {
      showStatus('No table to export. Load CSV first.', 'error');
      return;
    }
    
    // Show loading state
    const exportBtn = document.getElementById('exportBtn');
    const originalHtml = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    exportBtn.disabled = true;
    
    // Use data array directly - no grouping, exactly as displayed in the table
    const totals = calculateTotals();
    
    // Generate the table HTML
    let tableHTML = generateTableHTML(totals);
    
    // If template file is uploaded, insert table into it
    if (wordTemplateFile) {
      await insertTableIntoTemplate(wordTemplateFile, tableHTML, exportBtn, originalHtml);
      return;
    }
    
    // Build HTML for Word export
    let html = `
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="ProgId" content="Word.Document">
      <meta name="Generator" content="Microsoft Word 15">
      <meta name="Originator" content="Microsoft Word 15">
      <title>COMBINED COMMERCIAL INVOICE & PACKING LIST No. 43967</title>
      <!--[if gte mso 9]>
      <xml>
        <w:WordDocument>
          <w:View>Print</w:View>
          <w:Zoom>100</w:Zoom>
          <w:DoNotOptimizeForBrowser/>
          <w:ValidateAgainstSchemas/>
          <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
          <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
          <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
          <w:Compatibility>
            <w:BreakWrappedTables/>
            <w:SnapToGridInCell/>
            <w:WrapTextWithPunct/>
            <w:UseAsianBreakRules/>
            <w:DontGrowAutofit/>
            <w:UseFELayout/>
          </w:Compatibility>
        </w:WordDocument>
      </xml>
      <![endif]-->
      <style>
        /* @page rules for A4 landscape */
        @page {
          size: A4 landscape;
          margin: 1.5cm 1cm 1.5cm 1cm;
          mso-header-margin: 1.0cm;
          mso-footer-margin: 1.0cm;
          mso-title-page: yes;
          mso-page-orientation: landscape;
        }
        
        body {
          font-family: 'Arial', 'Helvetica', sans-serif;
          margin: 0;
          padding: 0;
          background: white;
          font-size: 12.0pt;
          line-height: 1.15;
          text-align: left;
          -ms-text-justify: inter-word;
          width: 100%;
          mso-font-charset: 0;
          mso-generic-font-family: auto;
          mso-font-pitch: variable;
          mso-font-signature: 0 0 0 0 0 0;
        }
        
        /* Main title */
        .main-title {
          text-align: center;
          font-size: 20.0pt;
          font-weight: bold;
          margin: 0;
          margin-bottom: 20px;
          padding: 0;
          text-decoration: underline;
          mso-margin-top-alt: 0in;
          mso-margin-bottom-alt: 0in;
        }
        
        /* Form sections with horizontal lines - borderless tables */
        .form-section {
          width: 100%;
          margin: 15px 0;
          font-size: 11.0pt;
        }
        
        .form-table {
          width: 100%;
          border-collapse: collapse;
          border: none;
          margin-bottom: 12px;
          mso-table-lspace: 0pt;
          mso-table-rspace: 0pt;
        }
        
        .form-table td {
          border: none;
          padding: 0;
          vertical-align: bottom;
        }
        
        .form-label {
          font-weight: bold;
          white-space: nowrap;
          padding-right: 10px;
          vertical-align: bottom;
          width: 1%;
        }
        
        .form-label.underlined {
          text-decoration: underline;
        }
        
        .form-input-line {
          border-bottom: 1.0pt solid windowtext;
          vertical-align: bottom;
          padding-left: 5px;
          padding-bottom: 2px;
          width: 100%;
        }
        
        .form-input-line.filled {
          border-bottom: none;
        }
        
        .form-value {
          text-decoration: underline;
        }
        
        .form-year {
          font-size: 14.0pt;
          font-weight: bold;
          margin-top: 8px;
        }
        
        .form-seoul {
          font-size: 12.0pt;
          font-weight: bold;
          margin-top: 5px;
        }
        
        .form-remarks-title {
          font-weight: bold;
          text-decoration: underline;
          margin-bottom: 8px;
        }
        
        .form-consignee-title {
          font-weight: bold;
          margin-bottom: 2px;
        }
        
        .form-date {
          font-weight: bold;
          text-decoration: underline;
          font-size: 11.0pt;
          margin-top: 12px;
        }
        
        .form-remarks-options {
          font-size: 10.0pt;
          line-height: 1.6;
          margin-top: 12px;
          margin-left: 20px;
        }
        
        .form-note {
          font-size: 9.0pt;
          font-style: italic;
          margin-top: 8px;
        }
        
        .two-column-table {
          width: 100%;
          border-collapse: collapse;
          border: none;
          mso-table-lspace: 0pt;
          mso-table-rspace: 0pt;
        }
        
        .two-column-table td {
          border: none;
          padding: 0 20px 0 0;
          vertical-align: top;
          width: 50%;
        }
        
        .two-column-table td:last-child {
          padding: 0 0 0 20px;
        }
        
        /* Inventory table - with borders for data table only */
        .inventory-table {
          border-collapse: collapse;
          border: 2.5pt solid windowtext;
          margin: 20px auto;
          width: 100%;
          font-size: 10.0pt;
          table-layout: auto;
          page-break-inside: avoid;
          mso-table-layout-alt: auto;
          mso-border-alt: solid windowtext 1.0pt;
          mso-yfti-tbllook: 1184;
        }
        
        /* Table headers */
        .inventory-table th {
          border: 1.0pt solid windowtext;
          padding: 8pt 4pt;
          background-color: #F0F0F0;
          font-weight: bold;
          text-align: center;
          vertical-align: middle;
          mso-border-alt: solid windowtext .5pt;
          mso-pattern: solid #F0F0F0;
          mso-shading: windowtext;
        }
        
        /* Main header row */
        .main-header {
          font-size: 11.0pt;
          font-weight: bold;
          height: 50px;
          mso-height-rule: exactly;
        }
        
        /* Sub-header row */
        .sub-header {
          font-size: 9.0pt;
          font-weight: bold;
          height: 35px;
          mso-height-rule: exactly;
        }
        
        /* Table data cells */
        .inventory-table td {
          border: 1.0pt solid windowtext;
          padding: 6pt 4pt;
          vertical-align: middle;
          mso-border-alt: solid windowtext .5pt;
        }
        
        /* Column alignments */
        .center {
          text-align: center;
        }
        
        .left {
          text-align: left;
          padding-left: 8px;
        }
        
        /* Specific column styles */
        .col-case { 
          width: 6%;
          text-align: center;
        }
        
        .col-dims { 
          width: 10%;
          text-align: left;
          padding-left: 4px;
        }
        
        .col-volume { 
          width: 6%;
          text-align: center;
        }
        
        .col-weight { 
          width: 5%;
          text-align: center;
        }
        
        .col-desc { 
          width: 20%;
          text-align: left;
          padding-left: 4px;
        }
        
        .col-origin { 
          width: 8%;
          text-align: center;
        }
        
        .col-sn { 
          width: 15%;
          text-align: left;
          padding-left: 4px;
          font-size: 9.0pt;
          line-height: 1.3;
        }
        
        .col-qty { 
          width: 6%;
          text-align: center;
        }
        
        .col-cif { 
          width: 7%;
          text-align: center;
        }
        
        .col-remarks { 
          width: 4%;
          text-align: center;
          font-weight: bold;
          font-size: 11.0pt;
        }
        
        /* Total row */
        .total-row {
          font-weight: bold;
          background-color: #F8F8F8;
          mso-pattern: solid #F8F8F8;
        }
        
        .total-row td {
          border-top: 2.5pt solid windowtext;
          padding: 9.0pt 3.6pt;
          mso-border-top-alt: solid windowtext 2.5pt;
        }
        
        /* Footer section - EXACTLY as shown in image */
        .footer-container {
          margin-top: 40px;
          font-size: 10.0pt;
          line-height: 1.5;
          width: 100%;
        }
        
        .footer-line-1 {
          white-space: nowrap;
          margin-bottom: 5px;
        }
        
        .footer-line-2 {
          white-space: nowrap;
          margin-bottom: 10px;
        }
        
        .footer-line-3 {
          white-space: nowrap;
          margin-top: 20px;
        }
        
        .customs-no {
          display: inline-block;
          width: 150px;
          border-bottom: 1px solid #000;
          text-align: center;
        }
        
        .empty-space {
          display: inline-block;
          width: 100px;
        }
        
        .country-box {
          display: inline-block;
          width: 100px;
          border: 1px solid #000;
          padding: 2px 5px;
          text-align: center;
          font-weight: bold;
        }
        
        .date-box {
          display: inline-block;
          width: 150px;
          border: 1px solid #000;
          padding: 2px 5px;
          text-align: center;
          margin-left: 20px;
        }
        
        .signature-line {
          display: inline-block;
          width: 300px;
          border-bottom: 1px solid #000;
          margin-left: 10px;
        }
        
        .page-box {
          display: inline-block;
          width: 30px;
          border: 1px solid #000;
          padding: 1px 3px;
          text-align: center;
          font-weight: bold;
        }
        
        .spacer {
          display: inline-block;
          width: 50px;
        }
        
        .footer-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }
        
        .footer-table td {
          padding: 2px 5px;
          vertical-align: top;
        }
        
        .text-right {
          text-align: right;
        }
        
        .text-left {
          text-align: left;
        }
        
        .text-center {
          text-align: center;
        }
        
        /* Print-specific adjustments */
        @media print {
          body {
            margin: 0;
            padding: 0;
          }
          
          .inventory-table {
            width: 100% !important;
          }
          
          .footer-container {
            position: absolute;
            bottom: 2cm;
            width: 100%;
          }
        }
        
        /* Word-specific compatibility */
        p.MsoNormal {
          margin: 0;
          margin-bottom: .0001pt;
          font-size: 12.0pt;
          font-family: "Arial", sans-serif;
          mso-pagination: widow-orphan;
          mso-layout-grid-align: none;
          punctuation-wrap: hanging;
          text-autospace: none;
        }
        
        /* Additional Word compatibility */
        p {
          margin: 0;
          margin-bottom: .0001pt;
          mso-margin-top-alt: auto;
          mso-margin-bottom-alt: auto;
        }
        
        table {
          mso-displayed-decimal-separator: "\\.";
          mso-displayed-thousand-separator: "\\,";
        }
        
        /* Ensure proper Word rendering */
        span {
          mso-ansi-font-size: 12.0pt;
        }
      </style>
    </head>
    <body lang="EN-US" link="#0563C1" vlink="#954F72" style="tab-interval:.5in; word-wrap:break-word">
    
    <!-- Template Header with Form Fields -->
    ${generateTemplateHeader()}
    
    <!-- Inventory Table - Generated from generateTableHTML() function -->
    ${tableHTML}
    
    <!-- Declaration Footer -->
    ${generateDeclarationFooter()}
    
    </body>
    </html>`;

    // Create the Word document blob
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const defaultFileName = `Commercial_Invoice_43967_${new Date().toISOString().slice(0,10)}.doc`;
    
    // Use File System Access API if available (allows selecting existing file to overwrite)
    if ('showSaveFilePicker' in window) {
      async function saveFile() {
        try {
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: defaultFileName,
            types: [{
              description: 'Word Documents',
              accept: {
                'application/msword': ['.doc'],
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx']
              }
            }]
          });
          
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          
          // Update counters and UI
          exportCount++;
          updateDashboard();
          
          showStatus('✅ Word file saved successfully! (Existing file was overwritten if you selected one)');
          
          // Restore button
          exportBtn.innerHTML = originalHtml;
          exportBtn.disabled = false;
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Error saving file:', err);
            showStatus('Error saving file: ' + err.message, 'error');
          } else {
            showStatus('File save cancelled', 'error');
          }
          exportBtn.innerHTML = originalHtml;
          exportBtn.disabled = false;
        }
      }
      
      saveFile();
    } else {
      // Fallback for browsers that don't support File System Access API
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = defaultFileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Update counters and UI
      exportCount++;
      updateDashboard();
      
      showStatus('✅ Word file downloaded! (Your browser doesn\'t support file overwrite. Please manually replace the file if needed.)');
      
      // Restore button
      setTimeout(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
      }, 1000);
    }
    
  } catch (error) {
    showStatus('Export error: ' + error.message, 'error');
    exportBtn.innerHTML = originalHtml;
    exportBtn.disabled = false;
  }
}
function refreshTable() {
  if (data.length > 0) {
    renderTable();
    showStatus('Table refreshed successfully');
  } else {
    showStatus('No data to refresh. Import a CSV file first.', 'error');
  }
}

// Initialize with sample data for demo
setTimeout(() => {
  if (data.length === 0) {
    document.getElementById('systemStatus').textContent = 'Ready for import';
    document.getElementById('systemStatus').style.color = '#4cc9f0';
  }
}, 1000);
</script>
</body>
</html>